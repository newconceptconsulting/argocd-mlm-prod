apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-declarative
  namespace: default
data:
  kong.yml: |
    _format_version: "2.1"

    services:
      - name: httpbin
        url: http://httpbin.default.svc.cluster.local:80
        routes:
          - name: httpbin-route
            hosts:
              - mlm.nccnaga.com
            protocols:
              - https
        tls:
          certificate:
            secret: mlm-nccnaga-cert
          key:
            secret: mlm-nccnaga-cert

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: httpbin
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: httpbin
  template:
    metadata:
      labels:
        app: httpbin
    spec:
      containers:
        - name: httpbin
          image: kennethreitz/httpbin
          ports:
            - containerPort: 80

---
apiVersion: v1
kind: Service
metadata:
  name: httpbin
  namespace: default
spec:
  selector:
    app: httpbin
  ports:
    - port: 80
      targetPort: 80

---
apiVersion: batch/v1
kind: Job
metadata:
  name: kong-db-import
  namespace: default
  annotations:
    "argocd.argoproj.io/hook": PostSync
    "argocd.argoproj.io/hook-delete-policy": HookSucceeded
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: kong-import
          image: kong:3.7
          command:
            - /bin/sh
            - -c
            - |
              echo "Importing declarative config into Kong DB..."
              kong config db_import /tmp/kong.yml
              kong reload
          volumeMounts:
            - name: kong-config
              mountPath: /tmp/kong.yml
              subPath: kong.yml
      volumes:
        - name: kong-config
          configMap:
            name: kong-declarative
